package priv.hkon.theseq.cutscenes;

import priv.hkon.theseq.filters.Filter;
import priv.hkon.theseq.filters.SnowFilter;
import priv.hkon.theseq.main.Core;
import priv.hkon.theseq.misc.VillageEvent;
import priv.hkon.theseq.sprites.Movable;
import priv.hkon.theseq.sprites.Player;
import priv.hkon.theseq.sprites.TalkativeSprite;
import priv.hkon.theseq.sprites.Woodcutter;

public class PlayerTriesCompleteWoodcutterRequest extends Cutscene {
	
	Player player;
	Woodcutter woodcutter;
	
	SnowFilter snow;
	
	boolean shadow = false;

	public PlayerTriesCompleteWoodcutterRequest(Woodcutter wc, Player p, Core core) {
		super(core);
		
		player = p;
		woodcutter = wc;
		player.isPartOfCutscene = true;
		wc.isPartOfCutscene = true;
		
		snow = new SnowFilter();
		
		if(woodcutter.storage.getCrate().numItems() > 10){
			if(core.village.timesSeenShadow == 0){
				shadow = true;
				core.village.timesSeenShadow++;
				happenings.add(new Happening(player, 2*60){
					public void happen(){
						((Movable)sprite).startPathTo(sprite.getX(), sprite.getY() + 2);
					}
				});
			}else{
				happenings.add(new Happening(player, 0){
					public void happen(){
						((Movable)sprite).startPathTo(sprite.getX(), sprite.getY() - 2);
					}
				});
				
				happenings.add(new Happening(woodcutter, 2*60){
					public void happen(){
						((TalkativeSprite)sprite).addAndShowSentence(new String[] {
							"So you're done?",
							"Ok, then, I'll let you free",
							"You did well! Don't be surprised if I ask you again"
						});
					}
				});
				
				happenings.add(new Happening(player, new VillageEvent(core.village, woodcutter){
					public boolean isHappening(){
						return !((TalkativeSprite)subject).showDialog;
					}
				}){
					public void happen(){
						((Movable)sprite).startPathTo(sprite.getX(), sprite.getY() - 2);
					}
				});
			}
		}
		
		happenings.add(new Happening(woodcutter, 30){
			public void happen(){
				((TalkativeSprite)sprite).showDialog("Hey there!", 2*60);
			}
		});
	}
	public void tick(){
		if(shadow){
			core.setCutsceneFilter(snow);
		}else{
			core.setCutsceneFilter(Filter.NO_FILTER);
		}
		super.tick();
	}

	@Override
	public boolean isFinished() {
		return core.village.ownedBy(player.getX(), player.getY()) == null;
	}

}
